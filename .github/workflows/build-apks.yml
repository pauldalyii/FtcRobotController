name: Build and Test APKs

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build-and-verify-apks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug

      - name: Verify Debug APK exists
        run: |
          echo "Checking for debug APK..."
          DEBUG_APK=$(find . -name "*-debug.apk" -type f | head -n 1)
          if [ -z "$DEBUG_APK" ]; then
            echo "ERROR: Debug APK not found!"
            exit 1
          fi
          echo "✓ Debug APK found: $DEBUG_APK"
          ls -lh "$DEBUG_APK"

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Verify Release APK exists
        run: |
          echo "Checking for release APK..."
          RELEASE_APK=$(find . -name "*-release.apk" -type f | head -n 1)
          if [ -z "$RELEASE_APK" ]; then
            echo "ERROR: Release APK not found!"
            exit 1
          fi
          echo "✓ Release APK found: $RELEASE_APK"
          ls -lh "$RELEASE_APK"

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: "**/*-debug.apk"
          retention-days: 7

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: "**/*-release.apk"
          retention-days: 7

      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Debug APK built successfully" >> $GITHUB_STEP_SUMMARY
          echo "✅ Release APK built successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### APK Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Debug APK:**" >> $GITHUB_STEP_SUMMARY
          find . -name "*-debug.apk" -type f -exec ls -lh {} \; \
            | awk '{print "- Size: " $5 ", Path: " $9}' \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release APK:**" >> $GITHUB_STEP_SUMMARY
          find . -name "*-release.apk" -type f -exec ls -lh {} \; \
            | awk '{print "- Size: " $5 ", Path: " $9}' \
            >> $GITHUB_STEP_SUMMARY
